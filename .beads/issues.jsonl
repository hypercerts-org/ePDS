{"id":"atproto-0vq","title":"Add tutorials for Flow 1 and Flow 2","description":"docs/flows.md currently describes both login flows as numbered steps and will eventually have Mermaid diagrams (atproto-y1l), but there are no end-to-end tutorials showing developers how to actually implement each flow in a client app.\n\nAdd a tutorial for each flow in docs/flows.md (or a new docs/tutorials/ directory), covering:\n\n## Flow 1 tutorial — app has its own email form\n- Setting up the /api/oauth/login server endpoint (PAR request with login_hint, DPoP key generation)\n- Redirecting to /oauth/authorize with login_hint passthrough\n- Handling the callback and exchanging the code for tokens\n- Reference the maearth-demo app (/data/projects/maearth-demo) as a working example\n\n## Flow 2 tutorial — app has a login button only\n- Setting up the /api/oauth/login server endpoint (PAR request without login_hint)\n- Redirecting to /oauth/authorize (no login_hint)\n- Handling the callback and exchanging the code for tokens\n- Note: Flow 2 is not yet tested end-to-end (atproto-daj) — tutorial should be written once atproto-daj is resolved\n\n## Both tutorials should cover\n- Client metadata JSON (what fields are required, where to host it)\n- DPoP: key generation, nonce handling, binding tokens\n- Error handling (expired request_uri, bad OTP, etc.)\n- User handle format (random, not email-derived)\n- Code snippets in TypeScript (Next.js API route style, matching maearth-demo)","status":"open","priority":3,"issue_type":"task","owner":"atproto@adamspiers.org","created_at":"2026-02-21T11:04:04Z","created_by":"Adam Spiers","updated_at":"2026-02-21T11:04:04Z","dependencies":[{"issue_id":"atproto-0vq","depends_on_id":"atproto-daj","type":"blocks","created_at":"2026-02-21T11:04:08Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-7ep","title":"Settings page broken after login","description":"After a successful OAuth login, the settings page in the client app is broken. Root cause unknown — needs investigation. Discovered during end-to-end testing of the maearth-demo app.","status":"open","priority":3,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-21T10:25:15Z","created_by":"Adam Spiers","updated_at":"2026-02-21T10:26:43Z"}
{"id":"atproto-9kf","title":"Update recovery flow to use better-auth OTP and /_internal/account-by-email","description":"The current recovery flow (routes/recovery.ts) allows login via backup email. Update it to:\n1. Use better-auth's OTP infrastructure (auth.api.sendVerificationOTP()) for verification instead of custom token service\n2. Call /_internal/account-by-email for backup email→DID lookup instead of reading from account_email table\n3. Integrate with the auth_flow table so request_uri is preserved through recovery\n\nThis is orthogonal to the main login flow but must use the same bridge pattern (better-auth session → /auth/complete → HMAC-signed magic-callback).\n\nRef: better-auth-migration-plan.md 'Open question: Recovery via backup email'","status":"closed","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:19:00Z","created_by":"Adam Spiers","updated_at":"2026-02-20T13:04:33Z","closed_at":"2026-02-20T13:04:33Z","close_reason":"Rewrote recovery.ts to use better-auth OTP: auth.api.sendVerificationOTP() for sending, auth.api.signInEmailOTP() for verification. After successful OTP, redirects to /auth/complete (bridge pattern) with magic_auth_flow cookie set to thread request_uri. Backup email lookup via ctx.db.getDidByBackupEmail() retained (auth-service-owned data). 9 recovery tests added, all 83 tests pass.","dependencies":[{"issue_id":"atproto-9kf","depends_on_id":"atproto-bvg","type":"blocks","created_at":"2026-02-20T02:19:11Z","created_by":"Adam Spiers","metadata":"{}"},{"issue_id":"atproto-9kf","depends_on_id":"atproto-cr3","type":"blocks","created_at":"2026-02-20T02:19:11Z","created_by":"Adam Spiers","metadata":"{}"},{"issue_id":"atproto-9kf","depends_on_id":"atproto-hg3","type":"blocks","created_at":"2026-02-20T02:19:12Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-ab0","title":"Wire email sending into better-auth sendVerificationOTP callback","description":"## Context\n\nPart of Phase 2 of the better-auth migration plan. See `better-auth-migration-plan.md`.\n\n## Problem\n\nbetter-auth's emailOTP plugin needs a `sendVerificationOTP` callback to actually deliver OTP codes. The existing `EmailSender` class in `packages/auth-service/src/email/sender.ts` supports SMTP, SendGrid, AWS SES, and Postmark, plus custom client-branded templates. This infrastructure should be reused.\n\n## Solution\n\nWire the existing `EmailSender.sendOtpCode()` into the `sendVerificationOTP` callback in `packages/auth-service/src/better-auth.ts`.\n\n### Client branding challenge\n\nThe current template system needs a `client_id` to resolve branding (logo, colors, email template). During a better-auth emailOTP flow, the `sendVerificationOTP` callback does not have access to the OAuth client context.\n\nSolution: read the `magic_auth_flow` cookie from the request context to recover the `flow_id`, look up the `auth_flow` row to get the `client_id`, and pass it to `emailSender.sendOtpCode()`.\n\nIf the request does not have a `magic_auth_flow` cookie (e.g., account settings login), use the default PDS email template.\n\n## Files to modify\n\n- `packages/auth-service/src/better-auth.ts` — wire sendVerificationOTP callback\n\n## Acceptance criteria\n\n- [ ] OTP emails delivered via existing EmailSender infrastructure\n- [ ] Client branding applied when client_id available from auth_flow\n- [ ] Default template used when no client_id context\n- [ ] All four email providers (SMTP, SendGrid, SES, Postmark) still work\n- [ ] Dev mode (no provider configured) still logs to console","status":"closed","priority":2,"issue_type":"task","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:17:11Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:56:45Z","closed_at":"2026-02-20T12:56:45Z","close_reason":"Wired existing EmailSender into sendVerificationOTP callback with client branding support. createBetterAuth() now accepts MagicPdsDb; callback reads magic_auth_flow cookie via ctx.getCookie(), looks up auth_flow to get client_id, passes to emailSender.sendOtpCode(). Falls back to default template when no flow context. 6 tests added. 81 tests pass.","dependencies":[{"issue_id":"atproto-ab0","depends_on_id":"atproto-bvg","type":"blocks","created_at":"2026-02-20T02:18:43Z","created_by":"Adam Spiers","metadata":"{}"},{"issue_id":"atproto-ab0","depends_on_id":"atproto-cr3","type":"blocks","created_at":"2026-02-20T02:18:44Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-aon","title":"Passwordless accounts missing account row causes device binding FK failure","description":"When creating a new account via magic-callback, the PDS oauth-store's createAccount() skips registerAccount() when password is undefined (condition: email \u0026\u0026 passwordScrypt). This leaves the account table empty while actor has a row. The account_device table has a FK on account.did (not actor.did), so upsertDeviceAccount() fails with SQLITE_CONSTRAINT_FOREIGNKEY.\n\nRoot cause: packages/pds-core/src/index.ts passes password: undefined to provider.accountManager.createAccount(). The PDS oauth-store.js line ~168 gates registerAccount() on both email AND passwordScrypt being truthy.\n\nFix applied: after createAccount() returns, manually insert a minimal account row (did, email, passwordScrypt: null) via pds.ctx.accountManager.db before calling upsertDeviceAccount(). This satisfies the FK while keeping the account passwordless.\n\nAlso discovered: account_device FK references account.did (not actor.did or device.id separately verified). WAL timing was a red herring — same DB connection is used, the row was simply never written.","notes":"Additional finding: account.passwordScrypt has a NOT NULL constraint in the schema, so inserting null fails. Used sentinel value 'passwordless' instead — not a valid scrypt hash so password auth will always fail for these accounts.","status":"closed","priority":1,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T22:21:11Z","created_by":"Adam Spiers","updated_at":"2026-02-21T01:04:55Z","closed_at":"2026-02-21T01:04:55Z","close_reason":"Fixed by passing a random 256-bit password to createAccount() so registerAccount() runs and the account row is created properly."}
{"id":"atproto-bjv","title":"Eliminate account_email mirror table; use accountManager directly in pds-core","description":"## Context\n\nPart of the better-auth migration plan. See `better-auth-migration-plan.md` (design decisions 5–6).\n\n## Problem\n\npds-core currently opens the auth-service's `magic-pds.sqlite` to look up email→DID via an `account_email` mirror table, with a three-step fallback chain:\n1. `magicDb.getDidByEmail(email)` — reads `account_email` in magic-pds.sqlite\n2. `magicDb.getDidByBackupEmail(email)` — reads `backup_email` in magic-pds.sqlite\n3. `magicDb.getDidFromPdsAccount(email)` — opens `account.sqlite` read-only as a fallback\n\nThis is redundant because the upstream PDS already stores email→DID in `account.sqlite`, and `pds.ctx.accountManager.getAccountByEmail()` is a public method that queries it directly.\n\n## Solution\n\n1. In pds-core's `/oauth/magic-callback` handler, replace the `magicDb.getDidByEmail()` + `magicDb.getDidFromPdsAccount()` fallback chain with a single call to `pds.ctx.accountManager.getAccountByEmail(email)`.\n\n2. Keep the backup email lookup — but have it call `/_internal/account-by-email` or the auth-service's own `backup_email` table via HTTP (backup emails are auth-service-owned data with no PDS equivalent).\n\n3. Remove pds-core's `MagicPdsDb` instantiation entirely — pds-core no longer opens the auth-service database.\n\n4. Delete `getDidByEmail`, `getDidFromPdsAccount`, `setAccountEmail` from `packages/shared/src/db.ts`.\n\n5. Drop the `account_email` table from the auth-service SQLite file.\n\n## Files to modify\n\n- `packages/pds-core/src/index.ts` — replace magicDb calls with accountManager; remove MagicPdsDb import and instantiation\n- `packages/shared/src/db.ts` — remove getDidByEmail, getDidFromPdsAccount, setAccountEmail, and account_email table creation/migration\n\n## Acceptance criteria\n\n- [ ] pds-core no longer imports or instantiates MagicPdsDb\n- [ ] pds-core no longer opens magic-pds.sqlite\n- [ ] Magic callback uses pds.ctx.accountManager.getAccountByEmail() for email→DID lookup\n- [ ] account_email table dropped from auth-service SQLite schema\n- [ ] getDidByEmail, getDidFromPdsAccount, setAccountEmail removed from shared/db.ts\n- [ ] New account creation still writes to account.sqlite via createAccount (unchanged)\n- [ ] Login flow works end-to-end","status":"closed","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:58Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:36:58Z","closed_at":"2026-02-20T12:36:58Z","close_reason":"Removed account_email mirror table from shared/db.ts (v5 migration drops it), removed getDidByEmail/getDidFromPdsAccount/setAccountEmail/getEmailByDid methods. Updated pds-core to use pds.ctx.accountManager.getAccountByEmail() directly, removed MagicPdsDb instantiation. Updated auth-service verify-code and account-login to query /_internal/account-by-email. All 63 tests pass.","dependencies":[{"issue_id":"atproto-bjv","depends_on_id":"atproto-hg3","type":"blocks","created_at":"2026-02-20T02:18:41Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-bvg","title":"Install better-auth and mount alongside existing code","description":"## Context\n\nThis is Phase 1 of the better-auth migration plan. See `better-auth-migration-plan.md` for the full plan.\n\n## Goal\n\nInstall better-auth as a dependency, configure it with emailOTP plugin, and mount it on the auth-service Express app alongside the existing routes. No existing behavior changes — this is a foundation-only step.\n\n## Implementation\n\n### 1.1 Install dependencies\n\n```bash\npnpm add better-auth better-sqlite3\n# better-sqlite3 is already a dependency — verify version compatibility\n```\n\n### 1.2 Create better-auth configuration\n\nCreate `packages/auth-service/src/better-auth.ts` with:\n- `betterAuth()` instance configured with:\n  - `database`: points to `process.env.DB_LOCATION ?? \"./data/magic-pds.sqlite\"` (shared auth-service SQLite)\n  - `baseURL`: `https://${process.env.AUTH_HOSTNAME}`\n  - `basePath`: `/api/auth` (namespaced to avoid route conflicts)\n  - `emailOTP` plugin with `otpLength: 8`, `expiresIn: 600`, `allowedAttempts: 5`, `storeOTP: \"hashed\"`, and `sendVerificationOTP` callback wired to existing `EmailSender`\n  - `socialProviders` built dynamically from env vars — `buildSocialProviders()` checks for `GOOGLE_CLIENT_ID`+`GOOGLE_CLIENT_SECRET`, `GITHUB_CLIENT_ID`+`GITHUB_CLIENT_SECRET`, etc. Only providers with both vars set are included.\n  - `session.expiresIn` from `SESSION_EXPIRES_IN` env var (default 7 days)\n  - `session.updateAge` from `SESSION_UPDATE_AGE` env var (default 1 day)\n- Export `socialProviders` object so login page can conditionally render buttons\n\n### 1.3 Run better-auth migrations\n\n```bash\npnpm dlx @better-auth/cli migrate\n```\n\nCreates `user`, `session`, `account`, `verification` tables in the auth-service SQLite file alongside existing custom tables.\n\n### 1.4 Mount on Express\n\nIn `packages/auth-service/src/index.ts`, mount before `express.json()`:\n\n```typescript\nimport { toNodeHandler } from \"better-auth/node\";\nimport { auth } from \"./better-auth\";\napp.all(\"/api/auth/*\", toNodeHandler(auth));\n```\n\nExisting routes continue to work unchanged.\n\n## Files to create\n\n- `packages/auth-service/src/better-auth.ts`\n\n## Files to modify\n\n- `packages/auth-service/src/index.ts` — mount better-auth handler\n- `packages/auth-service/package.json` — add better-auth dependency\n- `.env.example` — add SESSION_EXPIRES_IN, SESSION_UPDATE_AGE, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET\n\n## Acceptance criteria\n\n- [ ] better-auth tables created in auth-service SQLite without breaking existing tables\n- [ ] `/api/auth/*` endpoints respond (better-auth health check)\n- [ ] Existing OTP login flow still works unchanged\n- [ ] No behavior change for users","status":"closed","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:42Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:22:16Z","closed_at":"2026-02-20T12:22:16Z","close_reason":"Installed better-auth 1.4.18 and better-sqlite3 as auth-service dependencies. Created packages/auth-service/src/better-auth.ts with betterAuth() configured with emailOTP plugin (otpLength:8, expiresIn:600, allowedAttempts:5, storeOTP:hashed) wired to existing EmailSender, dynamic social providers from env vars, and session lifetime from env. Mounted at /api/auth/* in index.ts before express.json(). Also converted auth-service to type:module (ESM) to support better-auth which is ESM-only. Fixed SMTPTransport type import in email/sender.ts. Added MAGIC_INTERNAL_SECRET, SESSION_EXPIRES_IN, SESSION_UPDATE_AGE, GOOGLE_CLIENT_ID/SECRET, GITHUB_CLIENT_ID/SECRET to .env.example. All 65 tests pass."}
{"id":"atproto-cco","title":"Enable social providers (Google, GitHub) via env-var config","description":"Phase 4 of the migration plan. Since buildSocialProviders() already auto-detects from env vars and the login page conditionally renders buttons:\n\n1. Document the required env vars (GOOGLE_CLIENT_ID/SECRET, GITHUB_CLIENT_ID/SECRET) in .env.example\n2. Test the full flow: social login → better-auth session → /auth/complete bridge → HMAC-signed magic-callback\n3. Verify account linking: same email from social provider links to existing better-auth user\n4. Handle email mismatch risk: display warning if social provider email differs from known PDS account\n\nNo changes to pds-core or the bridge route needed — the bridge always reads email from the better-auth session regardless of how the user authenticated.\n\nRef: better-auth-migration-plan.md Phase 4","status":"closed","priority":3,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:19:06Z","created_by":"Adam Spiers","updated_at":"2026-02-20T13:06:21Z","closed_at":"2026-02-20T13:06:21Z","close_reason":"Documented social provider env vars in .env.example with flow description, account linking behavior, email mismatch warning, and links to OAuth credential pages. Social provider buttons already rendered in login-page.ts (atproto-sbw) and auto-detection already in better-auth.ts (atproto-bvg). Added 11 social provider tests. 94 tests total pass.","dependencies":[{"issue_id":"atproto-cco","depends_on_id":"atproto-sbw","type":"blocks","created_at":"2026-02-20T02:19:13Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-ch9","title":"Migrate account settings portal to better-auth sessions","description":"## Context\n\nPhase 3 of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 3.\n\n## Problem\n\nThe `/account/*` routes on the auth-service currently use a custom `account_session` table and `magic_account_session` cookie for session management. This should use better-auth's built-in session system instead.\n\n## Solution\n\n1. Replace `requireAuth(ctx)` calls with a wrapper that calls `auth.api.getSession({ headers })` to validate the better-auth session.\n\n2. The \"Account Settings Login\" flow becomes: render login page → user authenticates via better-auth → session established → redirect to auth-service `/account`.\n\n3. Session revocation routes delegate to better-auth:\n   - `POST /account/session/revoke` → `auth.api.revokeSession()`\n   - `POST /account/sessions/revoke-all` → `auth.api.revokeSessions()`\n\n4. These routes stay custom (they call PDS admin APIs):\n   - `POST /account/handle` — calls `com.atproto.admin.updateAccountHandle`\n   - `POST /account/delete` — calls `com.atproto.admin.deleteAccount`\n   - `POST /account/backup-email/*` — custom backup_email table + verification\n\n5. Update `GET /metrics` to query better-auth's tables (user count, session count) alongside existing custom tables.\n\n### Delete on completion\n\n- `packages/auth-service/src/middleware/account-auth.ts`\n- `packages/auth-service/src/routes/account-login.ts`\n- `packages/auth-service/src/middleware/session.ts`\n- Drop `account_session` table from auth-service SQLite\n\n## Files to modify\n\n- `packages/auth-service/src/routes/account-settings.ts` — use better-auth session\n- `packages/auth-service/src/index.ts` — remove old account-auth middleware\n\n## Files to delete\n\n- `packages/auth-service/src/middleware/account-auth.ts`\n- `packages/auth-service/src/routes/account-login.ts`\n- `packages/auth-service/src/middleware/session.ts`\n\n## Acceptance criteria\n\n- [ ] Account settings pages use better-auth session\n- [ ] Old account_session table dropped\n- [ ] Session revocation works via better-auth\n- [ ] Handle change, account deletion, backup email management still work\n- [ ] Metrics endpoint queries better-auth tables","status":"closed","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:59Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:48:27Z","closed_at":"2026-02-20T12:48:27Z","close_reason":"Migrated /account/* routes to better-auth session management. Replaced custom account_session table + magic_account_session cookie with better-auth APIs. account-login now uses email OTP via better-auth. account-settings uses auth.api.getSession/listSessions/revokeSession/signOut. v7 migration drops account_session table. Deleted account-auth.ts and session.ts middleware. All 63 tests pass.","dependencies":[{"issue_id":"atproto-ch9","depends_on_id":"atproto-bvg","type":"blocks","created_at":"2026-02-20T02:18:47Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-cr3","title":"Build auth_flow table and AT Protocol bridge route","description":"## Context\n\nPhase 2 core of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 2.\n\n## Problem\n\nThe AT Protocol OAuth flow starts with a PAR `request_uri` that must survive the authentication process and arrive at pds-core's `/oauth/magic-callback`. Currently this is threaded through HTML hidden form fields and stored in the `magic_link_token` DB row. With better-auth, the OTP/social-login flow is opaque — we cannot embed `request_uri` in better-auth's internal state.\n\n## Solution\n\n### auth_flow table\n\nAdd a new `auth_flow` table to the auth-service SQLite:\n\n```sql\nCREATE TABLE auth_flow (\n  flow_id TEXT PRIMARY KEY,\n  request_uri TEXT NOT NULL,\n  client_id TEXT,\n  email TEXT,\n  created_at INTEGER NOT NULL,\n  expires_at INTEGER NOT NULL\n);\n```\n\nCleanup: delete expired rows on the same 5-minute interval as existing token cleanup.\n\n### Bridge route: auth-service `GET /auth/complete`\n\nThis is the route better-auth redirects to after successful authentication. It is the `callbackURL` passed to better-auth's sign-in methods.\n\nSteps:\n1. Read `magic_auth_flow` cookie → get flow_id\n2. Look up auth_flow row → get request_uri, client_id\n3. Get better-auth session via `auth.api.getSession({ headers })`\n4. Extract verified email from session\n5. Check consent needed (reuse existing client_logins logic)\n6. If consent needed → redirect to auth-service `/auth/consent?flow_id=...`\n7. Otherwise → build HMAC-signed redirect URL:\n   - Compute HMAC-SHA256(request_uri || email || approved || new_account || ts, MAGIC_CALLBACK_SECRET)\n   - Redirect to pds-core `/oauth/magic-callback?...\u0026ts=...\u0026sig=...`\n8. Delete auth_flow row + clear cookie\n\n## Files to create\n\n- `packages/auth-service/src/routes/complete.ts` — the bridge route\n\n## Files to modify\n\n- `packages/shared/src/db.ts` — add auth_flow table creation/migration + CRUD methods\n- `packages/auth-service/src/index.ts` — mount the /auth/complete route\n\n## Acceptance criteria\n\n- [ ] auth_flow table created in auth-service SQLite\n- [ ] Expired auth_flow rows cleaned up periodically\n- [ ] Bridge route reads better-auth session and extracts verified email\n- [ ] Bridge route produces HMAC-signed redirect to pds-core /oauth/magic-callback\n- [ ] Consent flow still works (redirect to /auth/consent when needed)\n- [ ] Cookie set/cleared correctly","status":"closed","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:15Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:41:53Z","closed_at":"2026-02-20T12:41:53Z","close_reason":"Added auth_flow table (v6 migration) to shared/db.ts with createAuthFlow/getAuthFlow/deleteAuthFlow/cleanupExpiredAuthFlows CRUD methods. Created packages/auth-service/src/routes/complete.ts bridge route that reads magic_auth_flow cookie, validates auth_flow record, gets better-auth session via fromNodeHeaders, determines isNewAccount via PDS internal endpoint, handles consent redirect, and issues HMAC-signed redirect to pds-core /oauth/magic-callback. Mounted in index.ts and wired cleanup in context.ts. 67 tests pass.","dependencies":[{"issue_id":"atproto-cr3","depends_on_id":"atproto-bvg","type":"blocks","created_at":"2026-02-20T02:18:42Z","created_by":"Adam Spiers","metadata":"{}"},{"issue_id":"atproto-cr3","depends_on_id":"atproto-ibt","type":"blocks","created_at":"2026-02-20T02:18:42Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-daj","title":"Flow 2 (app has login button, no login_hint) is untested and likely broken","description":"Flow 2 — where the client app has a simple 'Login' button and no email form of its own — has never been tested end-to-end. Only Flow 1 (login_hint passed via PAR) has been verified working.\n\n## What Flow 2 is supposed to do\n\n1. Client redirects to /oauth/authorize with no login_hint\n2. Auth server renders the email input form (step-email div, visible by default)\n3. User enters email, submits form\n4. JS calls sendOtp(email) → POST /api/auth/email-otp/send-verification-otp\n5. On success, JS calls showOtpStep(email) to transition to OTP input\n6. User enters OTP code\n7. JS calls verifyOtp(email, otp) → POST /api/auth/sign-in/email-otp\n8. On success, redirects to /auth/complete\n9. /auth/complete reads magic_auth_flow cookie → issues AT Protocol auth code via /oauth/magic-callback\n10. Client exchanges code for tokens\n\n## Current code state\n\nThe email form and JS transition path exists in login-page.ts (step-email div rendered\nvisible when no loginHint, form-send-otp submit handler calls sendOtp → showOtpStep).\nHowever it has not been exercised and may have issues at any step.\n\n## What needs investigating / testing\n\n- Does a client without login_hint successfully redirect to /oauth/authorize?\n- Does the email form render correctly?\n- Does sendOtp succeed (better-auth endpoint reachable, correct request format)?\n- Does showOtpStep transition work (CSS classes, currentEmail set correctly)?\n- Does verifyOtp succeed and redirect to /auth/complete?\n- Does /auth/complete correctly pick up the magic_auth_flow cookie in this path?\n- Does magic-callback create the PDS account correctly for a new user?\n- Does the whole token exchange complete?\n\n## Reference implementation\n\nThe maearth-demo app at /data/projects/maearth-demo only implements Flow 1.\nTo test Flow 2, either modify maearth-demo to skip the login_hint, or use a\nseparate minimal client (e.g. curl + browser) that redirects to /oauth/authorize\nwithout login_hint.","status":"open","priority":2,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-21T10:57:58Z","created_by":"Adam Spiers","updated_at":"2026-02-21T10:57:58Z"}
{"id":"atproto-exe","title":"Update consent screen to use auth_flow table","description":"## Context\n\nPhase 2 of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 2.4.\n\n## Problem\n\nThe current consent screen (`routes/consent.ts`) reads `request_uri` directly from query parameters. With the new auth_flow-based architecture, the request_uri is stored in the `auth_flow` table, keyed by flow_id.\n\n## Solution\n\nUpdate `GET/POST /auth/consent` on the auth-service to:\n- Read `flow_id` from query parameter (or `magic_auth_flow` cookie) instead of `request_uri` directly\n- Look up `auth_flow` row to get `request_uri` and `client_id`\n- After consent is granted, build HMAC-signed redirect URL to pds-core `/oauth/magic-callback`\n- Delete the old `routes/consent.ts` implementation (replace in-place)\n\n## Files to modify\n\n- `packages/auth-service/src/routes/consent.ts` — rewrite to use auth_flow table\n\n## Acceptance criteria\n\n- [ ] Consent screen reads request_uri from auth_flow table via flow_id\n- [ ] After consent, redirect is HMAC-signed\n- [ ] First-time consent tracking (client_logins table) still works\n- [ ] Consent screen still displays client branding","status":"closed","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:44Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:53:46Z","closed_at":"2026-02-20T12:53:46Z","close_reason":"Updated consent screen to support flow_id mode: GET reads request_uri/client_id from auth_flow table via flow_id query param. POST approves by looking up auth_flow, deletes the row after use, and builds HMAC-signed redirect to pds-core /oauth/magic-callback. Legacy direct request_uri mode retained for backward compat. complete.ts updated to pass flow_id to consent instead of request_uri, deferring auth_flow cleanup. 12 tests pass.","dependencies":[{"issue_id":"atproto-exe","depends_on_id":"atproto-cr3","type":"blocks","created_at":"2026-02-20T02:18:46Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-hg3","title":"Replace /_magic/check-email with protected /_internal/account-by-email","description":"## Problem\n\nThe `/_magic/check-email` endpoint on pds-core returns `{ exists: true/false, did: \"...\" }` for any email with no authentication. It is an email enumeration oracle. It also reads from the `account_email` mirror table in `magic-pds.sqlite`, which we are eliminating as part of the broader migration to use `account.sqlite` as the single source of truth.\n\n**Identified in the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities) as MED-4.**\n\nSee also: `better-auth-migration-plan.md` Phase 0.4\n\n## Solution\n\nReplace `/_magic/check-email` with `/_internal/account-by-email`, which:\n- Requires `x-internal-secret` header matching `MAGIC_INTERNAL_SECRET` env var\n- Queries `pds.ctx.accountManager.getAccountByEmail()` directly — the upstream PDS already has this as a public method on AccountManager (in `node_modules/@atproto/pds/src/account-manager/account-manager.ts`). It queries `account.sqlite` directly — no mirror table needed.\n- Returns `{ did: string } | { did: null }`\n\n## Implementation\n\n1. In `packages/pds-core/src/index.ts`, add the new endpoint:\n\n```typescript\napp.get(\"/_internal/account-by-email\", async (req, res) =\u003e {\n  if (req.headers[\"x-internal-secret\"] !== process.env.MAGIC_INTERNAL_SECRET) {\n    return res.status(401).json({ error: \"Unauthorized\" });\n  }\n  const email = req.query.email as string;\n  if (!email) return res.status(400).json({ error: \"Missing email\" });\n  const account = await pds.ctx.accountManager.getAccountByEmail(email);\n  res.json({ did: account?.did ?? null });\n});\n```\n\n2. Update auth-service to call `/_internal/account-by-email` with `x-internal-secret` header instead of calling `/_magic/check-email`.\n\n3. Delete `/_magic/check-email` from pds-core.\n\n4. Add `MAGIC_INTERNAL_SECRET` to `.env.example`.\n\n## Files to modify\n\n- `packages/pds-core/src/index.ts` — add new endpoint, delete old one\n- `packages/auth-service/src/routes/` (any file calling check-email) — update to new endpoint\n- `.env.example` — add MAGIC_INTERNAL_SECRET\n\n## Acceptance criteria\n\n- [ ] `/_internal/account-by-email` requires x-internal-secret header\n- [ ] Unauthenticated calls return 401\n- [ ] Valid calls return `{ did: \"...\" }` or `{ did: null }`\n- [ ] `/_magic/check-email` is deleted\n- [ ] Auth-service uses the new endpoint successfully","status":"closed","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:22Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:15:02Z","closed_at":"2026-02-20T12:15:02Z","close_reason":"Added /_internal/account-by-email endpoint to pds-core requiring x-internal-secret header, querying pds.ctx.accountManager.getAccountByEmail() directly. Deleted /_magic/check-email. Updated auth-service account-login.ts to call the new protected endpoint. Added MAGIC_INTERNAL_SECRET to .env.example."}
{"id":"atproto-hqw","title":"Stop assigning random passwords to new accounts","description":"## Problem\n\nAccounts are created with a random 64-byte hex password (`crypto.randomBytes(64).toString('hex')`) in two places:\n- `packages/pds-core/src/index.ts:130`\n- `packages/auth-service/src/lib/auto-provision.ts:20`\n\nThis password is never shown to users but is a valid credential for `com.atproto.server.createSession`. If it were ever leaked (logs, memory dump, DB access), it bypasses the entire auth service.\n\n**Identified in the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities) as MED-3.**\n\nSee also: `better-auth-migration-plan.md` Phase 0.3\n\n## Solution\n\nPass `password: undefined` when creating accounts. The PDS `accountManager.createAccount()` already handles this — it sets `passwordScrypt` to `undefined`, meaning:\n- `createSession` rejects login (no hash to compare against)\n- Password reset has nothing to reset\n- Users who later want password-based login can use the stock PDS `requestPasswordReset` → `resetPassword` flow to set one — this works even when no password was previously set\n\n## Implementation\n\n1. In `packages/pds-core/src/index.ts:130`, change `password: randomBytes(64).toString('hex')` to `password: undefined`\n2. In `packages/auth-service/src/lib/auto-provision.ts:20`, same change\n3. Verify the PDS handles passwordless accounts correctly — test that `createSession` returns a proper error (not a crash) when there is no password hash\n\n## Acceptance criteria\n\n- [ ] New accounts are created with no password\n- [ ] `createSession` returns a clear error for passwordless accounts (not a 500)\n- [ ] `requestPasswordReset` + `resetPassword` can set a password on a previously passwordless account\n- [ ] Existing login flow via OTP is unaffected","status":"closed","priority":1,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:07Z","created_by":"Adam Spiers","updated_at":"2026-02-20T12:14:57Z","closed_at":"2026-02-20T12:14:57Z","close_reason":"Removed random password generation from both auto-provision.ts (removed password field from XRPC call entirely since lexicon accepts optional) and pds-core/src/index.ts (used undefined as unknown as string to bypass SignUpInput schema type since no runtime schema validation at direct call site). Also removed unused crypto import from both files."}
{"id":"atproto-i75","title":"Create SKILL.md for developing frontend login/signup flows against ePDS","description":"Create a Claude Code skill (SKILL.md) that helps AI agents implement AT Protocol OAuth login and signup flows against an ePDS instance.\n\nThe skill should live at .claude/skills/epds-login/SKILL.md in this repo, making it installable via:\n\n  npx skills add \u003cowner\u003e/ePDS@epds-login\n\nIt should be authored following the skill-authoring conventions in ~/.GIT/adamspiers.org/ai-config/.claude/skills/skill-authoring/SKILL.md (progressive disclosure, YAML frontmatter, concise, gerundial name, etc).\n\nScope of the skill:\n- Flow 1 (app has email form, passes login_hint to PAR)\n- Flow 2 (app has login button, auth server shows email form)\n- PAR request structure (endpoint, params, login_hint, DPoP)\n- Authorization redirect (including login_hint passthrough for Flow 1)\n- Token exchange (code + DPoP)\n- Client metadata format (client_id URL, required fields)\n- Handle format (random, not email-derived)\n- Common pitfalls (e.g. missing login_hint in redirect, DPoP nonce handling)\n\nReference material to draw from:\n- docs/flows.md (login flow descriptions)\n- README.md (PAR request, client metadata, token exchange sections)\n- docs/architecture.md (system overview)\n- packages/auth-service/src/routes/login-page.ts (auth server behaviour)\n- maearth-demo app at /data/projects/maearth-demo (working reference implementation)\n\nThe skill should use progressive disclosure: core PAR/redirect/token flow in SKILL.md body, with detailed reference files (references/flows.md, references/client-metadata.md, etc.) for deeper content. Keep SKILL.md body under 500 lines.","status":"open","priority":3,"issue_type":"task","owner":"atproto@adamspiers.org","created_at":"2026-02-21T10:45:36Z","created_by":"Adam Spiers","updated_at":"2026-02-21T10:45:36Z"}
{"id":"atproto-ibt","title":"CRITICAL: Sign magic callback with HMAC-SHA256","description":"## Problem\n\nThe `/oauth/magic-callback` endpoint on pds-core accepts security-critical authorization decisions as plain, unsigned query parameters:\n\n```\nGET /oauth/magic-callback?request_uri=urn:...\u0026email=victim@example.com\u0026approved=1\u0026new_account=0\n```\n\nAn attacker who initiates a legitimate OAuth flow (getting a valid `request_uri` via PAR) can directly call the magic-callback with the victim's email instead of completing OTP verification. If the PDS port is reachable (misconfigured firewall, Docker port mapping, open redirect), any account can be taken over without any authentication factor.\n\n**This is the most severe finding from the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities).**\n\nSee also: `better-auth-migration-plan.md` Phase 0.1\n\n## Solution\n\nAdd a shared HMAC-SHA256 secret between auth-service and pds-core. The auth-service computes a signature over the callback parameters and a timestamp, appending `\u0026ts=...\u0026sig=...` to the redirect URL. pds-core verifies the signature before issuing an authorization code.\n\n## Implementation\n\n1. Add `MAGIC_CALLBACK_SECRET` env var (shared by both services). Generate with `openssl rand -hex 32`.\n\n2. In `packages/shared/src/crypto.ts`, add `signCallback()`:\n   - Input: `{ request_uri, email, approved, new_account }` + secret\n   - Compute `ts = Math.floor(Date.now() / 1000)`\n   - Payload: `[request_uri, email, approved, new_account, ts].join(\"\\n\")`\n   - Return HMAC-SHA256 hex digest + timestamp\n\n3. In `packages/shared/src/crypto.ts`, add `verifyCallback()`:\n   - Input: same params + ts + sig + secret\n   - Reject if timestamp older than 5 minutes or in the future\n   - Recompute HMAC and compare with `crypto.timingSafeEqual()`\n   - Return boolean\n\n4. In auth-service `routes/verify-code.ts` and `routes/consent.ts`: call `signCallback()` when building the redirect URL to `/oauth/magic-callback`. Append `\u0026ts=...\u0026sig=...`.\n\n5. In pds-core `packages/pds-core/src/index.ts`, in the `/oauth/magic-callback` handler: call `verifyCallback()` before any account operations. Return 403 on failure, 400 on expiry.\n\n6. Update `.env.example` with `MAGIC_CALLBACK_SECRET`.\n\n## Files to modify\n\n- `packages/shared/src/crypto.ts` — add signCallback/verifyCallback\n- `packages/pds-core/src/index.ts` — add HMAC verification at top of magic-callback handler\n- `packages/auth-service/src/routes/verify-code.ts` — sign redirect URL\n- `packages/auth-service/src/routes/consent.ts` — sign redirect URL\n- `.env.example` — add MAGIC_CALLBACK_SECRET\n\n## Acceptance criteria\n\n- [ ] Unsigned requests to `/oauth/magic-callback` return 403\n- [ ] Requests with expired timestamps (\u003e5 min) return 400\n- [ ] Requests with valid signatures proceed normally\n- [ ] Comparison uses timingSafeEqual (no timing side-channel)\n- [ ] Existing OTP login flow works end-to-end with HMAC in place","status":"closed","priority":0,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:14:35Z","created_by":"Adam Spiers","updated_at":"2026-02-20T11:15:20Z","closed_at":"2026-02-20T11:15:20Z","close_reason":"Implemented HMAC-SHA256 signing for magic-callback: added signCallback/verifyCallback to shared/crypto.ts, updated verify-code.ts and consent.ts to sign redirects, added verification in pds-core magic-callback handler (returns 403/400 on invalid/expired sig), added MAGIC_CALLBACK_SECRET to .env.example, and added 9 new tests covering all verification paths."}
{"id":"atproto-ke8","title":"Prevent flash of email login form when login_hint is present","description":"When /oauth/authorize is called with a login_hint email, the current implementation renders the full login page (including the email input step) and then client-side JS transitions to the OTP step after sending the OTP. This causes a brief flash of the email input form before the OTP step appears, which is confusing to users who already entered their email in the client app.\n\nFix: when login_hint is a valid email, send the OTP server-side during the GET /oauth/authorize handler and render the page already in the OTP step (hiding the email step entirely via HTML/CSS). No client-side transition needed — the OTP step should be immediately visible with no flash.","notes":"When this issue is resolved, also remove the 'known issue: brief flash of email form' caveat from README.md (Flow 1 description) and from docs/flows.md once that exists.","status":"open","priority":2,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-21T01:11:25Z","created_by":"Adam Spiers","updated_at":"2026-02-21T10:41:29Z"}
{"id":"atproto-n83","title":"Restructure docs: README for frontend devs, internals in docs/","description":"The README.md currently mixes two audiences:\n1. Frontend developers building client apps against the ePDS\n2. Contributors working on the ePDS itself\n\nSplit these concerns:\n- README.md should focus purely on helping frontend developers understand how to build against the ePDS: the two login flows, PAR/OAuth endpoints, login_hint convention, client metadata, callback handling, etc.\n- Internal architecture, package structure, deployment, configuration, and development setup should move to docs/ subdirectory (e.g. docs/architecture.md, docs/deployment.md, docs/development.md)\n\nThe Mermaid sequence diagrams (atproto-y1l) should go in docs/ as part of this restructure.","status":"closed","priority":3,"issue_type":"task","owner":"atproto@adamspiers.org","created_at":"2026-02-21T10:23:03Z","created_by":"Adam Spiers","updated_at":"2026-02-21T10:44:04Z","closed_at":"2026-02-21T10:44:04Z","close_reason":"README rewritten for frontend devs; architecture, deployment, development, configuration, and flows docs created in docs/"}
{"id":"atproto-qfr","title":"CRITICAL: Increase OTP to 8 digits and add per-email lockout","description":"## Problem\n\nThe current OTP system uses 6 digits (1,000,000 possibilities) with 5 attempts per token and 5 tokens per email per hour. This allows 25 guesses/hour. Over days or weeks this becomes non-trivial for a targeted attack against a specific account.\n\n**Identified in the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities) as CRITICAL-2.**\n\nSee also: `better-auth-migration-plan.md` Phase 0.2\n\n## Solution\n\n1. Increase OTP from 6 to 8 digits (100,000,000 possibilities — 100x harder brute-force)\n2. Add a per-email lockout after N total failed attempts across all tokens (e.g., 15 total failures in 1 hour → lock the email for 1 hour)\n\n## Implementation\n\n### 8-digit OTP (current codebase)\n\nIn `packages/shared/src/crypto.ts`, change `generateOtpCode()` to generate 8-digit codes instead of 6-digit codes. This is a single-line change to the `randomInt()` range.\n\nUpdate all email templates in `packages/auth-service/src/email/sender.ts` to accommodate 8-digit codes (the letter-spacing and font-size in the HTML templates may need slight adjustment).\n\n### 8-digit OTP (after better-auth migration)\n\nSet `otpLength: 8` in the `emailOTP` plugin configuration in `packages/auth-service/src/better-auth.ts`.\n\n### Per-email lockout\n\nAdd a new column or table tracking total failed attempts per email across all OTP tokens within a time window. When 15 failures occur within 1 hour, reject new OTP verification attempts for that email for 1 hour. This is orthogonal to the existing per-token attempt limit (5 per token).\n\n## Files to modify\n\n- `packages/shared/src/crypto.ts` — change OTP digit count\n- `packages/auth-service/src/email/sender.ts` — update email templates for 8-digit display\n- `packages/auth-service/src/magic-link/rate-limit.ts` or `packages/shared/src/db.ts` — add per-email lockout logic\n\n## Acceptance criteria\n\n- [ ] OTP codes are 8 digits\n- [ ] Email templates display 8 digits correctly\n- [ ] Per-email lockout activates after 15 total failed attempts in 1 hour\n- [ ] Lockout prevents new OTP verification (not sending — user can still request codes)\n- [ ] Existing login flow works with 8-digit codes","status":"closed","priority":0,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:14:52Z","created_by":"Adam Spiers","updated_at":"2026-02-20T11:17:56Z","closed_at":"2026-02-20T11:17:56Z","close_reason":"Increased OTP from 6 to 8 digits (100M possibilities), added per-email lockout (15 failures/hour → 1-hour lock) via new otp_failed_attempts table in db.ts with migration v4, updated token.ts to check and record failures, updated email templates for 8-digit display, added lockout test."}
{"id":"atproto-sbw","title":"Build unified login page with multiple auth methods","description":"## Context\n\nPhase 2 of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 2.4.\n\n## Problem\n\nThe current auth-service login flow is hardcoded for email OTP only (authorize.ts → send-code.ts → verify-code.ts). It needs to become a landing page offering multiple login methods.\n\n## Solution\n\nReplace the existing `GET /oauth/authorize` on the auth-service with a unified login page that:\n\n1. Receives `?request_uri=...\u0026client_id=...\u0026prompt=...\u0026login_hint=...` from the pds-core AS metadata redirect\n2. Creates an `auth_flow` row (flow_id, request_uri, client_id)\n3. Sets `magic_auth_flow` cookie (10 min, httpOnly)\n4. Resolves client metadata for branding via existing `lib/client-metadata.ts` (logo, colors, name)\n5. Renders a login page with:\n   - Email OTP form (calls better-auth `/api/auth/*` endpoints on auth-service)\n   - Social login buttons (only for providers enabled via env vars — check exported `socialProviders` object from `better-auth.ts`)\n   - \"Recover with backup email\" link (to existing recovery flow)\n\n### Social provider buttons\n\nThe login page template conditionally renders buttons based on `socialProviders`:\n```typescript\nif (\"google\" in socialProviders) { /* render Google button */ }\nif (\"github\" in socialProviders) { /* render GitHub button */ }\n```\n\nSocial login redirects to better-auth `/api/auth/sign-in/{provider}`, which handles the full OAuth exchange and redirects back to `/auth/complete` (the bridge route).\n\n### Delete on completion\n\nAfter this is working, delete the old files:\n- `routes/authorize.ts`, `routes/send-code.ts`, `routes/verify-code.ts`\n- `magic-link/token.ts`, `magic-link/rate-limit.ts`\n- `middleware/rate-limit.ts`, `middleware/csrf.ts`\n- Drop `magic_link_token` table from auth-service SQLite\n\nAlso remove `tokenService` and `rateLimiter` from `context.ts`.\n\n## Files to create\n\n- `packages/auth-service/src/routes/login-page.ts` — unified login page\n\n## Files to modify\n\n- `packages/auth-service/src/index.ts` — mount new /oauth/authorize, remove old routes\n- `packages/auth-service/src/context.ts` — remove tokenService, rateLimiter\n\n## Files to delete\n\n- `packages/auth-service/src/routes/authorize.ts`\n- `packages/auth-service/src/routes/send-code.ts`\n- `packages/auth-service/src/routes/verify-code.ts`\n- `packages/auth-service/src/magic-link/token.ts`\n- `packages/auth-service/src/magic-link/rate-limit.ts`\n- `packages/auth-service/src/middleware/rate-limit.ts`\n- `packages/auth-service/src/middleware/csrf.ts`\n\n## Acceptance criteria\n\n- [ ] Login page renders with email OTP form\n- [ ] Social login buttons appear only for configured providers\n- [ ] Client branding (logo, name, colors) displayed from OAuth metadata\n- [ ] Email OTP flow works end-to-end through better-auth\n- [ ] Social login (if configured) works end-to-end through better-auth → /auth/complete bridge\n- [ ] Old OTP route files deleted\n- [ ] Old middleware files deleted\n- [ ] context.ts cleaned up","status":"closed","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:34Z","created_by":"Adam Spiers","updated_at":"2026-02-20T13:04:32Z","closed_at":"2026-02-20T13:04:32Z","close_reason":"Created routes/login-page.ts: unified GET /oauth/authorize that creates auth_flow row, sets magic_auth_flow cookie, renders login page with better-auth email OTP form (JavaScript fetch to /api/auth/* endpoints) and optional social provider buttons (Google/GitHub via env vars). Client branding applied. Deleted old authorize.ts, send-code.ts, verify-code.ts. Removed tokenService/rateLimiter from context.ts, deleted magic-link/ directory. 10 login-page tests added, 83 tests total pass.","dependencies":[{"issue_id":"atproto-sbw","depends_on_id":"atproto-ab0","type":"blocks","created_at":"2026-02-20T02:18:46Z","created_by":"Adam Spiers","metadata":"{}"},{"issue_id":"atproto-sbw","depends_on_id":"atproto-cr3","type":"blocks","created_at":"2026-02-20T02:18:45Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-tlm","title":"Eliminate auth server redirect in flow 1 (app has own email form)","description":"In flow 1, where the client app collects the user's email itself and passes it as login_hint, there is no reason to redirect through /oauth/authorize at all before showing the OTP input. The current flow is:\n\n1. App collects email\n2. App POSTs to /api/oauth/login → PAR → redirects to /oauth/authorize?login_hint=email\n3. Auth server renders login page, JS auto-sends OTP, transitions to OTP step\n4. User enters OTP\n\nStep 3 is unnecessary indirection. Ideally the app could redirect directly to an OTP input page on the auth server, skipping the intermediate login page entirely. This would require a dedicated endpoint (e.g. /oauth/authorize/otp-challenge) that accepts login_hint, sends OTP server-side, and renders the OTP input directly — no login form involved at all.","status":"open","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-21T01:11:21Z","created_by":"Adam Spiers","updated_at":"2026-02-21T01:11:21Z"}
{"id":"atproto-trf","title":"Investigate server-side OTP send on login_hint (magic-pds vs current approach)","description":"The old magic-pds branch handled login_hint by sending the OTP server-side in the GET /oauth/authorize handler and rendering the OTP form directly as a full-page response (no flash, no JS transition needed). See authorize.ts on the magic-pds branch.\\n\\nThe current main branch unified everything into a single page (login-page.ts) with CSS show/hide and a JS-driven OTP send on page load. The uncommitted changes in login-page.ts are a partial improvement (pre-render OTP step server-side) but still send the OTP client-side via JS, so the subtitle 'We sent a code to...' is inaccurate at render time.\\n\\nThe proper fix is likely to restore the server-side OTP send approach from magic-pds, but the unified single-page architecture is different enough that this needs careful thought.\\n\\nInvestigation needed (requires owner input):\\n1. Produce Mermaid sequence diagrams of both approaches (blocked on atproto-n83 docs restructure, then atproto-y1l)\\n2. Review the diagrams with the owner to decide which approach to adopt\\n3. Decide what to do with the current uncommitted changes in login-page.ts (revert, keep, or replace)\\n4. Implement the agreed approach\\n\\nKey constraint: the unified single-page architecture may make a pure server-side send harder (better-auth OTP send is async and involves HTTP calls to the better-auth backend), so tradeoffs need discussion.","status":"open","priority":2,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-21T10:37:31Z","created_by":"Adam Spiers","updated_at":"2026-02-21T10:37:31Z","dependencies":[{"issue_id":"atproto-trf","depends_on_id":"atproto-y1l","type":"blocks","created_at":"2026-02-21T10:37:35Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-xk8","title":"Double OTP send: investigate whether /oauth/authorize should reject GET requests","description":"During testing, two OTP emails were sent for a single login attempt. The initial hypothesis was that the StayFocusd browser extension was making a duplicate GET request to /oauth/authorize, triggering a second auth_flow and a second OTP send.\n\nHowever, the root cause may be different: the login flow is initiated by the client app making a GET request to /oauth/authorize, and it is possible that:\n1. The request from the client app to initiate the login flow should be a POST, not a GET\n2. ePDS should reject GET requests to /oauth/authorize and only accept POST\n\nIf (1) is true, StayFocusd following the GET redirect URL would be harmless (since ePDS would reject it). If (2) is already enforced and was not the issue, the root cause is elsewhere.\n\nThe duplicate request that was observed came from a different IP and user-agent than the real browser. This is consistent with StayFocusd, but could also be another extension, a proxy, or a prefetch mechanism.\n\n## Investigation needed\n\nThe Mermaid sequence diagrams (atproto-y1l) will clarify exactly what HTTP method is used at each step of both flows and should be reviewed before drawing conclusions.\n\nQuestions to answer:\n- What HTTP method does the AT Protocol spec require for the authorization endpoint redirect?\n- Does ePDS currently accept GET, POST, or both for /oauth/authorize?\n- Is the duplicate request coming from before or after the PAR redirect?\n- If the fix is to require POST, what changes are needed in the client app (maearth-demo)?\n\n## Observed symptom\n- Two OTP emails sent to the same address for a single login attempt\n- Duplicate request from different IP/user-agent than the real browser\n- Only observed with StayFocusd extension installed; not reproduced in incognito","status":"open","priority":3,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-21T01:11:15Z","created_by":"Adam Spiers","updated_at":"2026-02-21T11:08:08Z","dependencies":[{"issue_id":"atproto-xk8","depends_on_id":"atproto-y1l","type":"blocks","created_at":"2026-02-21T11:07:53Z","created_by":"Adam Spiers","metadata":"{}"}]}
{"id":"atproto-y1l","title":"Add Mermaid sequence diagrams for flow 1 and flow 2","description":"Create Mermaid sequence diagrams documenting the two OAuth login flows:\n\nFlow 1: Client app has its own email form, passes login_hint to PAR, auth server skips email step and goes straight to OTP input.\nFlow 2: Client app has a simple login button, auth server shows the email input form itself.\n\nEmbed directly in a docs/flows.md file (or README.md) using GitHub-native Mermaid rendering (fenced code blocks with 'mermaid' language tag). GitHub renders these natively in the web UI with no build step required.\n\nDo NOT use separate .mmd files as these require manual PNG/SVG generation to be viewable in the GitHub UI.","status":"closed","priority":3,"issue_type":"task","owner":"atproto@adamspiers.org","created_at":"2026-02-21T10:22:25Z","created_by":"Adam Spiers","updated_at":"2026-02-21T11:10:17Z","closed_at":"2026-02-21T11:10:17Z","close_reason":"Added Mermaid sequence diagrams for both flows in docs/flows.md. Flow 1 fully detailed; Flow 2 marked as untested (atproto-daj). Both show HTTP methods, DPoP, HMAC signing, and account creation steps.","dependencies":[{"issue_id":"atproto-y1l","depends_on_id":"atproto-n83","type":"blocks","created_at":"2026-02-21T10:24:18Z","created_by":"Adam Spiers","metadata":"{}"}]}
