{"id":"atproto-9kf","title":"Update recovery flow to use better-auth OTP and /_internal/account-by-email","description":"The current recovery flow (routes/recovery.ts) allows login via backup email. Update it to:\n1. Use better-auth's OTP infrastructure (auth.api.sendVerificationOTP()) for verification instead of custom token service\n2. Call /_internal/account-by-email for backup email→DID lookup instead of reading from account_email table\n3. Integrate with the auth_flow table so request_uri is preserved through recovery\n\nThis is orthogonal to the main login flow but must use the same bridge pattern (better-auth session → /auth/complete → HMAC-signed magic-callback).\n\nRef: better-auth-migration-plan.md 'Open question: Recovery via backup email'","status":"open","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:19:00Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:19:00Z"}
{"id":"atproto-ab0","title":"Wire email sending into better-auth sendVerificationOTP callback","description":"## Context\n\nPart of Phase 2 of the better-auth migration plan. See `better-auth-migration-plan.md`.\n\n## Problem\n\nbetter-auth's emailOTP plugin needs a `sendVerificationOTP` callback to actually deliver OTP codes. The existing `EmailSender` class in `packages/auth-service/src/email/sender.ts` supports SMTP, SendGrid, AWS SES, and Postmark, plus custom client-branded templates. This infrastructure should be reused.\n\n## Solution\n\nWire the existing `EmailSender.sendOtpCode()` into the `sendVerificationOTP` callback in `packages/auth-service/src/better-auth.ts`.\n\n### Client branding challenge\n\nThe current template system needs a `client_id` to resolve branding (logo, colors, email template). During a better-auth emailOTP flow, the `sendVerificationOTP` callback does not have access to the OAuth client context.\n\nSolution: read the `magic_auth_flow` cookie from the request context to recover the `flow_id`, look up the `auth_flow` row to get the `client_id`, and pass it to `emailSender.sendOtpCode()`.\n\nIf the request does not have a `magic_auth_flow` cookie (e.g., account settings login), use the default PDS email template.\n\n## Files to modify\n\n- `packages/auth-service/src/better-auth.ts` — wire sendVerificationOTP callback\n\n## Acceptance criteria\n\n- [ ] OTP emails delivered via existing EmailSender infrastructure\n- [ ] Client branding applied when client_id available from auth_flow\n- [ ] Default template used when no client_id context\n- [ ] All four email providers (SMTP, SendGrid, SES, Postmark) still work\n- [ ] Dev mode (no provider configured) still logs to console","status":"open","priority":2,"issue_type":"task","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:17:11Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:17:11Z"}
{"id":"atproto-bjv","title":"Eliminate account_email mirror table; use accountManager directly in pds-core","description":"## Context\n\nPart of the better-auth migration plan. See `better-auth-migration-plan.md` (design decisions 5–6).\n\n## Problem\n\npds-core currently opens the auth-service's `magic-pds.sqlite` to look up email→DID via an `account_email` mirror table, with a three-step fallback chain:\n1. `magicDb.getDidByEmail(email)` — reads `account_email` in magic-pds.sqlite\n2. `magicDb.getDidByBackupEmail(email)` — reads `backup_email` in magic-pds.sqlite\n3. `magicDb.getDidFromPdsAccount(email)` — opens `account.sqlite` read-only as a fallback\n\nThis is redundant because the upstream PDS already stores email→DID in `account.sqlite`, and `pds.ctx.accountManager.getAccountByEmail()` is a public method that queries it directly.\n\n## Solution\n\n1. In pds-core's `/oauth/magic-callback` handler, replace the `magicDb.getDidByEmail()` + `magicDb.getDidFromPdsAccount()` fallback chain with a single call to `pds.ctx.accountManager.getAccountByEmail(email)`.\n\n2. Keep the backup email lookup — but have it call `/_internal/account-by-email` or the auth-service's own `backup_email` table via HTTP (backup emails are auth-service-owned data with no PDS equivalent).\n\n3. Remove pds-core's `MagicPdsDb` instantiation entirely — pds-core no longer opens the auth-service database.\n\n4. Delete `getDidByEmail`, `getDidFromPdsAccount`, `setAccountEmail` from `packages/shared/src/db.ts`.\n\n5. Drop the `account_email` table from the auth-service SQLite file.\n\n## Files to modify\n\n- `packages/pds-core/src/index.ts` — replace magicDb calls with accountManager; remove MagicPdsDb import and instantiation\n- `packages/shared/src/db.ts` — remove getDidByEmail, getDidFromPdsAccount, setAccountEmail, and account_email table creation/migration\n\n## Acceptance criteria\n\n- [ ] pds-core no longer imports or instantiates MagicPdsDb\n- [ ] pds-core no longer opens magic-pds.sqlite\n- [ ] Magic callback uses pds.ctx.accountManager.getAccountByEmail() for email→DID lookup\n- [ ] account_email table dropped from auth-service SQLite schema\n- [ ] getDidByEmail, getDidFromPdsAccount, setAccountEmail removed from shared/db.ts\n- [ ] New account creation still writes to account.sqlite via createAccount (unchanged)\n- [ ] Login flow works end-to-end","status":"open","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:58Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:15:58Z"}
{"id":"atproto-bvg","title":"Install better-auth and mount alongside existing code","description":"## Context\n\nThis is Phase 1 of the better-auth migration plan. See `better-auth-migration-plan.md` for the full plan.\n\n## Goal\n\nInstall better-auth as a dependency, configure it with emailOTP plugin, and mount it on the auth-service Express app alongside the existing routes. No existing behavior changes — this is a foundation-only step.\n\n## Implementation\n\n### 1.1 Install dependencies\n\n```bash\npnpm add better-auth better-sqlite3\n# better-sqlite3 is already a dependency — verify version compatibility\n```\n\n### 1.2 Create better-auth configuration\n\nCreate `packages/auth-service/src/better-auth.ts` with:\n- `betterAuth()` instance configured with:\n  - `database`: points to `process.env.DB_LOCATION ?? \"./data/magic-pds.sqlite\"` (shared auth-service SQLite)\n  - `baseURL`: `https://${process.env.AUTH_HOSTNAME}`\n  - `basePath`: `/api/auth` (namespaced to avoid route conflicts)\n  - `emailOTP` plugin with `otpLength: 8`, `expiresIn: 600`, `allowedAttempts: 5`, `storeOTP: \"hashed\"`, and `sendVerificationOTP` callback wired to existing `EmailSender`\n  - `socialProviders` built dynamically from env vars — `buildSocialProviders()` checks for `GOOGLE_CLIENT_ID`+`GOOGLE_CLIENT_SECRET`, `GITHUB_CLIENT_ID`+`GITHUB_CLIENT_SECRET`, etc. Only providers with both vars set are included.\n  - `session.expiresIn` from `SESSION_EXPIRES_IN` env var (default 7 days)\n  - `session.updateAge` from `SESSION_UPDATE_AGE` env var (default 1 day)\n- Export `socialProviders` object so login page can conditionally render buttons\n\n### 1.3 Run better-auth migrations\n\n```bash\npnpm dlx @better-auth/cli migrate\n```\n\nCreates `user`, `session`, `account`, `verification` tables in the auth-service SQLite file alongside existing custom tables.\n\n### 1.4 Mount on Express\n\nIn `packages/auth-service/src/index.ts`, mount before `express.json()`:\n\n```typescript\nimport { toNodeHandler } from \"better-auth/node\";\nimport { auth } from \"./better-auth\";\napp.all(\"/api/auth/*\", toNodeHandler(auth));\n```\n\nExisting routes continue to work unchanged.\n\n## Files to create\n\n- `packages/auth-service/src/better-auth.ts`\n\n## Files to modify\n\n- `packages/auth-service/src/index.ts` — mount better-auth handler\n- `packages/auth-service/package.json` — add better-auth dependency\n- `.env.example` — add SESSION_EXPIRES_IN, SESSION_UPDATE_AGE, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET\n\n## Acceptance criteria\n\n- [ ] better-auth tables created in auth-service SQLite without breaking existing tables\n- [ ] `/api/auth/*` endpoints respond (better-auth health check)\n- [ ] Existing OTP login flow still works unchanged\n- [ ] No behavior change for users","status":"open","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:42Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:15:42Z"}
{"id":"atproto-cco","title":"Enable social providers (Google, GitHub) via env-var config","description":"Phase 4 of the migration plan. Since buildSocialProviders() already auto-detects from env vars and the login page conditionally renders buttons:\n\n1. Document the required env vars (GOOGLE_CLIENT_ID/SECRET, GITHUB_CLIENT_ID/SECRET) in .env.example\n2. Test the full flow: social login → better-auth session → /auth/complete bridge → HMAC-signed magic-callback\n3. Verify account linking: same email from social provider links to existing better-auth user\n4. Handle email mismatch risk: display warning if social provider email differs from known PDS account\n\nNo changes to pds-core or the bridge route needed — the bridge always reads email from the better-auth session regardless of how the user authenticated.\n\nRef: better-auth-migration-plan.md Phase 4","status":"open","priority":3,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:19:06Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:19:06Z"}
{"id":"atproto-ch9","title":"Migrate account settings portal to better-auth sessions","description":"## Context\n\nPhase 3 of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 3.\n\n## Problem\n\nThe `/account/*` routes on the auth-service currently use a custom `account_session` table and `magic_account_session` cookie for session management. This should use better-auth's built-in session system instead.\n\n## Solution\n\n1. Replace `requireAuth(ctx)` calls with a wrapper that calls `auth.api.getSession({ headers })` to validate the better-auth session.\n\n2. The \"Account Settings Login\" flow becomes: render login page → user authenticates via better-auth → session established → redirect to auth-service `/account`.\n\n3. Session revocation routes delegate to better-auth:\n   - `POST /account/session/revoke` → `auth.api.revokeSession()`\n   - `POST /account/sessions/revoke-all` → `auth.api.revokeSessions()`\n\n4. These routes stay custom (they call PDS admin APIs):\n   - `POST /account/handle` — calls `com.atproto.admin.updateAccountHandle`\n   - `POST /account/delete` — calls `com.atproto.admin.deleteAccount`\n   - `POST /account/backup-email/*` — custom backup_email table + verification\n\n5. Update `GET /metrics` to query better-auth's tables (user count, session count) alongside existing custom tables.\n\n### Delete on completion\n\n- `packages/auth-service/src/middleware/account-auth.ts`\n- `packages/auth-service/src/routes/account-login.ts`\n- `packages/auth-service/src/middleware/session.ts`\n- Drop `account_session` table from auth-service SQLite\n\n## Files to modify\n\n- `packages/auth-service/src/routes/account-settings.ts` — use better-auth session\n- `packages/auth-service/src/index.ts` — remove old account-auth middleware\n\n## Files to delete\n\n- `packages/auth-service/src/middleware/account-auth.ts`\n- `packages/auth-service/src/routes/account-login.ts`\n- `packages/auth-service/src/middleware/session.ts`\n\n## Acceptance criteria\n\n- [ ] Account settings pages use better-auth session\n- [ ] Old account_session table dropped\n- [ ] Session revocation works via better-auth\n- [ ] Handle change, account deletion, backup email management still work\n- [ ] Metrics endpoint queries better-auth tables","status":"open","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:59Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:16:59Z"}
{"id":"atproto-cr3","title":"Build auth_flow table and AT Protocol bridge route","description":"## Context\n\nPhase 2 core of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 2.\n\n## Problem\n\nThe AT Protocol OAuth flow starts with a PAR `request_uri` that must survive the authentication process and arrive at pds-core's `/oauth/magic-callback`. Currently this is threaded through HTML hidden form fields and stored in the `magic_link_token` DB row. With better-auth, the OTP/social-login flow is opaque — we cannot embed `request_uri` in better-auth's internal state.\n\n## Solution\n\n### auth_flow table\n\nAdd a new `auth_flow` table to the auth-service SQLite:\n\n```sql\nCREATE TABLE auth_flow (\n  flow_id TEXT PRIMARY KEY,\n  request_uri TEXT NOT NULL,\n  client_id TEXT,\n  email TEXT,\n  created_at INTEGER NOT NULL,\n  expires_at INTEGER NOT NULL\n);\n```\n\nCleanup: delete expired rows on the same 5-minute interval as existing token cleanup.\n\n### Bridge route: auth-service `GET /auth/complete`\n\nThis is the route better-auth redirects to after successful authentication. It is the `callbackURL` passed to better-auth's sign-in methods.\n\nSteps:\n1. Read `magic_auth_flow` cookie → get flow_id\n2. Look up auth_flow row → get request_uri, client_id\n3. Get better-auth session via `auth.api.getSession({ headers })`\n4. Extract verified email from session\n5. Check consent needed (reuse existing client_logins logic)\n6. If consent needed → redirect to auth-service `/auth/consent?flow_id=...`\n7. Otherwise → build HMAC-signed redirect URL:\n   - Compute HMAC-SHA256(request_uri || email || approved || new_account || ts, MAGIC_CALLBACK_SECRET)\n   - Redirect to pds-core `/oauth/magic-callback?...\u0026ts=...\u0026sig=...`\n8. Delete auth_flow row + clear cookie\n\n## Files to create\n\n- `packages/auth-service/src/routes/complete.ts` — the bridge route\n\n## Files to modify\n\n- `packages/shared/src/db.ts` — add auth_flow table creation/migration + CRUD methods\n- `packages/auth-service/src/index.ts` — mount the /auth/complete route\n\n## Acceptance criteria\n\n- [ ] auth_flow table created in auth-service SQLite\n- [ ] Expired auth_flow rows cleaned up periodically\n- [ ] Bridge route reads better-auth session and extracts verified email\n- [ ] Bridge route produces HMAC-signed redirect to pds-core /oauth/magic-callback\n- [ ] Consent flow still works (redirect to /auth/consent when needed)\n- [ ] Cookie set/cleared correctly","status":"open","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:15Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:16:15Z"}
{"id":"atproto-exe","title":"Update consent screen to use auth_flow table","description":"## Context\n\nPhase 2 of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 2.4.\n\n## Problem\n\nThe current consent screen (`routes/consent.ts`) reads `request_uri` directly from query parameters. With the new auth_flow-based architecture, the request_uri is stored in the `auth_flow` table, keyed by flow_id.\n\n## Solution\n\nUpdate `GET/POST /auth/consent` on the auth-service to:\n- Read `flow_id` from query parameter (or `magic_auth_flow` cookie) instead of `request_uri` directly\n- Look up `auth_flow` row to get `request_uri` and `client_id`\n- After consent is granted, build HMAC-signed redirect URL to pds-core `/oauth/magic-callback`\n- Delete the old `routes/consent.ts` implementation (replace in-place)\n\n## Files to modify\n\n- `packages/auth-service/src/routes/consent.ts` — rewrite to use auth_flow table\n\n## Acceptance criteria\n\n- [ ] Consent screen reads request_uri from auth_flow table via flow_id\n- [ ] After consent, redirect is HMAC-signed\n- [ ] First-time consent tracking (client_logins table) still works\n- [ ] Consent screen still displays client branding","status":"open","priority":2,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:44Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:16:44Z"}
{"id":"atproto-hg3","title":"Replace /_magic/check-email with protected /_internal/account-by-email","description":"## Problem\n\nThe `/_magic/check-email` endpoint on pds-core returns `{ exists: true/false, did: \"...\" }` for any email with no authentication. It is an email enumeration oracle. It also reads from the `account_email` mirror table in `magic-pds.sqlite`, which we are eliminating as part of the broader migration to use `account.sqlite` as the single source of truth.\n\n**Identified in the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities) as MED-4.**\n\nSee also: `better-auth-migration-plan.md` Phase 0.4\n\n## Solution\n\nReplace `/_magic/check-email` with `/_internal/account-by-email`, which:\n- Requires `x-internal-secret` header matching `MAGIC_INTERNAL_SECRET` env var\n- Queries `pds.ctx.accountManager.getAccountByEmail()` directly — the upstream PDS already has this as a public method on AccountManager (in `node_modules/@atproto/pds/src/account-manager/account-manager.ts`). It queries `account.sqlite` directly — no mirror table needed.\n- Returns `{ did: string } | { did: null }`\n\n## Implementation\n\n1. In `packages/pds-core/src/index.ts`, add the new endpoint:\n\n```typescript\napp.get(\"/_internal/account-by-email\", async (req, res) =\u003e {\n  if (req.headers[\"x-internal-secret\"] !== process.env.MAGIC_INTERNAL_SECRET) {\n    return res.status(401).json({ error: \"Unauthorized\" });\n  }\n  const email = req.query.email as string;\n  if (!email) return res.status(400).json({ error: \"Missing email\" });\n  const account = await pds.ctx.accountManager.getAccountByEmail(email);\n  res.json({ did: account?.did ?? null });\n});\n```\n\n2. Update auth-service to call `/_internal/account-by-email` with `x-internal-secret` header instead of calling `/_magic/check-email`.\n\n3. Delete `/_magic/check-email` from pds-core.\n\n4. Add `MAGIC_INTERNAL_SECRET` to `.env.example`.\n\n## Files to modify\n\n- `packages/pds-core/src/index.ts` — add new endpoint, delete old one\n- `packages/auth-service/src/routes/` (any file calling check-email) — update to new endpoint\n- `.env.example` — add MAGIC_INTERNAL_SECRET\n\n## Acceptance criteria\n\n- [ ] `/_internal/account-by-email` requires x-internal-secret header\n- [ ] Unauthenticated calls return 401\n- [ ] Valid calls return `{ did: \"...\" }` or `{ did: null }`\n- [ ] `/_magic/check-email` is deleted\n- [ ] Auth-service uses the new endpoint successfully","status":"open","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:22Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:15:22Z"}
{"id":"atproto-hqw","title":"Stop assigning random passwords to new accounts","description":"## Problem\n\nAccounts are created with a random 64-byte hex password (`crypto.randomBytes(64).toString('hex')`) in two places:\n- `packages/pds-core/src/index.ts:130`\n- `packages/auth-service/src/lib/auto-provision.ts:20`\n\nThis password is never shown to users but is a valid credential for `com.atproto.server.createSession`. If it were ever leaked (logs, memory dump, DB access), it bypasses the entire auth service.\n\n**Identified in the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities) as MED-3.**\n\nSee also: `better-auth-migration-plan.md` Phase 0.3\n\n## Solution\n\nPass `password: undefined` when creating accounts. The PDS `accountManager.createAccount()` already handles this — it sets `passwordScrypt` to `undefined`, meaning:\n- `createSession` rejects login (no hash to compare against)\n- Password reset has nothing to reset\n- Users who later want password-based login can use the stock PDS `requestPasswordReset` → `resetPassword` flow to set one — this works even when no password was previously set\n\n## Implementation\n\n1. In `packages/pds-core/src/index.ts:130`, change `password: randomBytes(64).toString('hex')` to `password: undefined`\n2. In `packages/auth-service/src/lib/auto-provision.ts:20`, same change\n3. Verify the PDS handles passwordless accounts correctly — test that `createSession` returns a proper error (not a crash) when there is no password hash\n\n## Acceptance criteria\n\n- [ ] New accounts are created with no password\n- [ ] `createSession` returns a clear error for passwordless accounts (not a 500)\n- [ ] `requestPasswordReset` + `resetPassword` can set a password on a previously passwordless account\n- [ ] Existing login flow via OTP is unaffected","status":"open","priority":1,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:15:07Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:15:07Z"}
{"id":"atproto-ibt","title":"CRITICAL: Sign magic callback with HMAC-SHA256","description":"## Problem\n\nThe `/oauth/magic-callback` endpoint on pds-core accepts security-critical authorization decisions as plain, unsigned query parameters:\n\n```\nGET /oauth/magic-callback?request_uri=urn:...\u0026email=victim@example.com\u0026approved=1\u0026new_account=0\n```\n\nAn attacker who initiates a legitimate OAuth flow (getting a valid `request_uri` via PAR) can directly call the magic-callback with the victim's email instead of completing OTP verification. If the PDS port is reachable (misconfigured firewall, Docker port mapping, open redirect), any account can be taken over without any authentication factor.\n\n**This is the most severe finding from the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities).**\n\nSee also: `better-auth-migration-plan.md` Phase 0.1\n\n## Solution\n\nAdd a shared HMAC-SHA256 secret between auth-service and pds-core. The auth-service computes a signature over the callback parameters and a timestamp, appending `\u0026ts=...\u0026sig=...` to the redirect URL. pds-core verifies the signature before issuing an authorization code.\n\n## Implementation\n\n1. Add `MAGIC_CALLBACK_SECRET` env var (shared by both services). Generate with `openssl rand -hex 32`.\n\n2. In `packages/shared/src/crypto.ts`, add `signCallback()`:\n   - Input: `{ request_uri, email, approved, new_account }` + secret\n   - Compute `ts = Math.floor(Date.now() / 1000)`\n   - Payload: `[request_uri, email, approved, new_account, ts].join(\"\\n\")`\n   - Return HMAC-SHA256 hex digest + timestamp\n\n3. In `packages/shared/src/crypto.ts`, add `verifyCallback()`:\n   - Input: same params + ts + sig + secret\n   - Reject if timestamp older than 5 minutes or in the future\n   - Recompute HMAC and compare with `crypto.timingSafeEqual()`\n   - Return boolean\n\n4. In auth-service `routes/verify-code.ts` and `routes/consent.ts`: call `signCallback()` when building the redirect URL to `/oauth/magic-callback`. Append `\u0026ts=...\u0026sig=...`.\n\n5. In pds-core `packages/pds-core/src/index.ts`, in the `/oauth/magic-callback` handler: call `verifyCallback()` before any account operations. Return 403 on failure, 400 on expiry.\n\n6. Update `.env.example` with `MAGIC_CALLBACK_SECRET`.\n\n## Files to modify\n\n- `packages/shared/src/crypto.ts` — add signCallback/verifyCallback\n- `packages/pds-core/src/index.ts` — add HMAC verification at top of magic-callback handler\n- `packages/auth-service/src/routes/verify-code.ts` — sign redirect URL\n- `packages/auth-service/src/routes/consent.ts` — sign redirect URL\n- `.env.example` — add MAGIC_CALLBACK_SECRET\n\n## Acceptance criteria\n\n- [ ] Unsigned requests to `/oauth/magic-callback` return 403\n- [ ] Requests with expired timestamps (\u003e5 min) return 400\n- [ ] Requests with valid signatures proceed normally\n- [ ] Comparison uses timingSafeEqual (no timing side-channel)\n- [ ] Existing OTP login flow works end-to-end with HMAC in place","status":"closed","priority":0,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:14:35Z","created_by":"Adam Spiers","updated_at":"2026-02-20T11:15:20Z","closed_at":"2026-02-20T11:15:20Z","close_reason":"Implemented HMAC-SHA256 signing for magic-callback: added signCallback/verifyCallback to shared/crypto.ts, updated verify-code.ts and consent.ts to sign redirects, added verification in pds-core magic-callback handler (returns 403/400 on invalid/expired sig), added MAGIC_CALLBACK_SECRET to .env.example, and added 9 new tests covering all verification paths."}
{"id":"atproto-qfr","title":"CRITICAL: Increase OTP to 8 digits and add per-email lockout","description":"## Problem\n\nThe current OTP system uses 6 digits (1,000,000 possibilities) with 5 attempts per token and 5 tokens per email per hour. This allows 25 guesses/hour. Over days or weeks this becomes non-trivial for a targeted attack against a specific account.\n\n**Identified in the [magic-pds security review](https://gist.github.com/s-adamantine/c88df4fc940259cfe903e9de474f07fc#critical-vulnerabilities) as CRITICAL-2.**\n\nSee also: `better-auth-migration-plan.md` Phase 0.2\n\n## Solution\n\n1. Increase OTP from 6 to 8 digits (100,000,000 possibilities — 100x harder brute-force)\n2. Add a per-email lockout after N total failed attempts across all tokens (e.g., 15 total failures in 1 hour → lock the email for 1 hour)\n\n## Implementation\n\n### 8-digit OTP (current codebase)\n\nIn `packages/shared/src/crypto.ts`, change `generateOtpCode()` to generate 8-digit codes instead of 6-digit codes. This is a single-line change to the `randomInt()` range.\n\nUpdate all email templates in `packages/auth-service/src/email/sender.ts` to accommodate 8-digit codes (the letter-spacing and font-size in the HTML templates may need slight adjustment).\n\n### 8-digit OTP (after better-auth migration)\n\nSet `otpLength: 8` in the `emailOTP` plugin configuration in `packages/auth-service/src/better-auth.ts`.\n\n### Per-email lockout\n\nAdd a new column or table tracking total failed attempts per email across all OTP tokens within a time window. When 15 failures occur within 1 hour, reject new OTP verification attempts for that email for 1 hour. This is orthogonal to the existing per-token attempt limit (5 per token).\n\n## Files to modify\n\n- `packages/shared/src/crypto.ts` — change OTP digit count\n- `packages/auth-service/src/email/sender.ts` — update email templates for 8-digit display\n- `packages/auth-service/src/magic-link/rate-limit.ts` or `packages/shared/src/db.ts` — add per-email lockout logic\n\n## Acceptance criteria\n\n- [ ] OTP codes are 8 digits\n- [ ] Email templates display 8 digits correctly\n- [ ] Per-email lockout activates after 15 total failed attempts in 1 hour\n- [ ] Lockout prevents new OTP verification (not sending — user can still request codes)\n- [ ] Existing login flow works with 8-digit codes","status":"closed","priority":0,"issue_type":"bug","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:14:52Z","created_by":"Adam Spiers","updated_at":"2026-02-20T11:17:56Z","closed_at":"2026-02-20T11:17:56Z","close_reason":"Increased OTP from 6 to 8 digits (100M possibilities), added per-email lockout (15 failures/hour → 1-hour lock) via new otp_failed_attempts table in db.ts with migration v4, updated token.ts to check and record failures, updated email templates for 8-digit display, added lockout test."}
{"id":"atproto-sbw","title":"Build unified login page with multiple auth methods","description":"## Context\n\nPhase 2 of the better-auth migration plan. See `better-auth-migration-plan.md` Phase 2.4.\n\n## Problem\n\nThe current auth-service login flow is hardcoded for email OTP only (authorize.ts → send-code.ts → verify-code.ts). It needs to become a landing page offering multiple login methods.\n\n## Solution\n\nReplace the existing `GET /oauth/authorize` on the auth-service with a unified login page that:\n\n1. Receives `?request_uri=...\u0026client_id=...\u0026prompt=...\u0026login_hint=...` from the pds-core AS metadata redirect\n2. Creates an `auth_flow` row (flow_id, request_uri, client_id)\n3. Sets `magic_auth_flow` cookie (10 min, httpOnly)\n4. Resolves client metadata for branding via existing `lib/client-metadata.ts` (logo, colors, name)\n5. Renders a login page with:\n   - Email OTP form (calls better-auth `/api/auth/*` endpoints on auth-service)\n   - Social login buttons (only for providers enabled via env vars — check exported `socialProviders` object from `better-auth.ts`)\n   - \"Recover with backup email\" link (to existing recovery flow)\n\n### Social provider buttons\n\nThe login page template conditionally renders buttons based on `socialProviders`:\n```typescript\nif (\"google\" in socialProviders) { /* render Google button */ }\nif (\"github\" in socialProviders) { /* render GitHub button */ }\n```\n\nSocial login redirects to better-auth `/api/auth/sign-in/{provider}`, which handles the full OAuth exchange and redirects back to `/auth/complete` (the bridge route).\n\n### Delete on completion\n\nAfter this is working, delete the old files:\n- `routes/authorize.ts`, `routes/send-code.ts`, `routes/verify-code.ts`\n- `magic-link/token.ts`, `magic-link/rate-limit.ts`\n- `middleware/rate-limit.ts`, `middleware/csrf.ts`\n- Drop `magic_link_token` table from auth-service SQLite\n\nAlso remove `tokenService` and `rateLimiter` from `context.ts`.\n\n## Files to create\n\n- `packages/auth-service/src/routes/login-page.ts` — unified login page\n\n## Files to modify\n\n- `packages/auth-service/src/index.ts` — mount new /oauth/authorize, remove old routes\n- `packages/auth-service/src/context.ts` — remove tokenService, rateLimiter\n\n## Files to delete\n\n- `packages/auth-service/src/routes/authorize.ts`\n- `packages/auth-service/src/routes/send-code.ts`\n- `packages/auth-service/src/routes/verify-code.ts`\n- `packages/auth-service/src/magic-link/token.ts`\n- `packages/auth-service/src/magic-link/rate-limit.ts`\n- `packages/auth-service/src/middleware/rate-limit.ts`\n- `packages/auth-service/src/middleware/csrf.ts`\n\n## Acceptance criteria\n\n- [ ] Login page renders with email OTP form\n- [ ] Social login buttons appear only for configured providers\n- [ ] Client branding (logo, name, colors) displayed from OAuth metadata\n- [ ] Email OTP flow works end-to-end through better-auth\n- [ ] Social login (if configured) works end-to-end through better-auth → /auth/complete bridge\n- [ ] Old OTP route files deleted\n- [ ] Old middleware files deleted\n- [ ] context.ts cleaned up","status":"open","priority":1,"issue_type":"feature","owner":"atproto@adamspiers.org","created_at":"2026-02-20T02:16:34Z","created_by":"Adam Spiers","updated_at":"2026-02-20T02:16:34Z"}
