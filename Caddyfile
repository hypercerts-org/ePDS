{
    email admin@{$PDS_HOSTNAME:pds.example}
    on_demand_tls {
        interval 1m
        burst 10
    }
}

# PDS API + handle subdomains (on-demand TLS for handle resolution)
:443 {
    tls {
        on_demand
    }

    # Auth service
    @auth host auth.{$PDS_HOSTNAME:pds.example}
    handle @auth {
        reverse_proxy {$AUTH_UPSTREAM:auth:3001}

        header {
            X-Frame-Options "DENY"
            X-Content-Type-Options "nosniff"
            Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://{$PDS_HOSTNAME:pds.example}"
            Referrer-Policy "no-referrer"
            Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        }
    }

    # Everything else goes to PDS (main domain + handle subdomains)
    handle {
        reverse_proxy {$PDS_UPSTREAM:pds:3000} {
            header_up Connection {http.request.header.Connection}
            header_up Upgrade {http.request.header.Upgrade}
        }

        header {
            Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
            X-Content-Type-Options "nosniff"
        }
    }
}
